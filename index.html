<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flow for Good</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: linear-gradient(to bottom, #e0f7fa, #00b0ff);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #00b0ff;
      color: white;
    }
    .instruction-text {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    .game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 auto;
    }
    .icon-row {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .pipe-icon, .bucket-icon {
      font-size: 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(10, 30px);
      grid-template-rows: repeat(10, 30px);
      gap: 2px;
      justify-content: center;
      margin: 10px 0;
      background: #b3e5fc;
      padding: 5px;
      border-radius: 5px;
    }
    .tile {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
    }
    .dirt { background: #8d6e63; cursor: pointer; }
    .rock { background: #9e9e9e; }
    .dirty { background: #c97272; }
    .bonus { background: #ffd700; }
    .pipe { background: #00b0ff; }
    .bucket { background: #00b0ff; }
    .overlay, .feedback {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
    }
    .button {
      margin: 5px;
      padding: 10px 20px;
      background: #00b0ff;
      border: none;
      color: white;
      cursor: pointer;
    }
    .footer {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      color: #555;
      position: relative;
    }
    .footer:after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, transparent, #00b0ff, transparent);
      bottom: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>POINTS: <span id="points">0</span> ‚≠ê x<span id="bonus">0</span></div>
    <div>Flow for Good</div>
    <div>
      RESET <button id="resetBtn" title="Reset"><img src="img/reset.png" alt="Reset" style="height:18px;vertical-align:middle;"></button>
    </div>
  </div>

  <div class="instruction-text">
    <b>Create a path for the water to get to the bucket!</b>
  </div>

  <div class="game-area">
    <div class="icon-row">
      <span class="pipe-icon">‚õèÔ∏è</span>
    </div>
    <div class="grid" id="grid"></div>
    <div class="icon-row">
      <span class="bucket-icon">ü™£</span>
    </div>
  </div>

  <button class="button" id="startFlowBtn">Start Flow</button>

  <div class="overlay" id="instruction">
    <p>
      Click or drag across the tiles to dig a path from the tool to the bucket.<br>
      - Avoid pollution tiles!<br>
      - Collect bonus droplets for extra points.<br>
      - Use the reset button to clear your path.<br>
      - Click "Start Flow" to check your path.
    </p>
    <button class="button" id="hideInstructionBtn">Got it!</button>
  </div>

  <div class="feedback" id="success">
    <h2> Congratulations! üëè </h2>
    <p>You delivered clean water!</p>
    <p>+<span id="successPoints">10</span> points</p>
    <p>Every minute, someone begins walking for water.</p>
    <button class="button" id="nextLevelBtn">Next Level</button>
    <button class="button" id="playAgainBtn">Play Again</button>
  </div>

  <div class="feedback" id="finished">
    <h2>üéâ All Levels Complete!</h2>
    <p>Great job! You finished all 5 levels.</p>
    <button class="button" id="playAgainAllBtn">Play Again</button>
    <button class="button" id="stopBtn">Stop</button>
  </div>

  <div class="footer" style="position:fixed; left:0; right:0; bottom:0;">
    FLOW FOR GOOD
    <span style="margin: 0 8px;">ü§ù</span>
    charity: water
    <img src="img/cw.png" alt="charity: water logo" style="height:22px; margin-left:8px; vertical-align:middle;">
  </div>

  <script>
    const gridEl = document.getElementById('grid');
    const pointsEl = document.getElementById('points');
    const bonusEl = document.getElementById('bonus');
    let points = 0;
    let bonus = 0;
    let isDragging = false;
    let currentGridTypes = [];
    let currentRound = 1; // Track the current round (start at 1)
    const maxRounds = 5; // Total number of rounds

    function buildGrid(fromReset = false) {
      gridEl.innerHTML = '';
      if (!fromReset) {
        currentGridTypes = [];
        // Use the same obstacle/bonus frequency for all rounds
        let rockChance = 0.14;
        let dirtyChance = 0.08;
        let bonusChance = 0.04;
        for (let i = 0; i < 100; i++) {
          let type = 'dirt';
          let rand = Math.random();
          if (rand < rockChance) type = 'rock';
          else if (rand < rockChance + dirtyChance) type = 'dirty';
          else if (rand < rockChance + dirtyChance + bonusChance) type = 'bonus';
          currentGridTypes.push(type);
        }
      }
      for (let i = 0; i < 100; i++) {
        const tile = document.createElement('div');
        const type = currentGridTypes[i];
        tile.className = 'tile ' + type;
        if (type === 'rock') tile.textContent = 'ü™®';
        if (type === 'dirty') tile.textContent = '‚ö†Ô∏è';
        if (type === 'bonus') tile.textContent = 'üíß';
        tile.addEventListener('mousedown', () => {
          isDragging = true;
          digTile(tile);
        });
        tile.addEventListener('mouseover', () => {
          if (isDragging) digTile(tile);
        });
        tile.addEventListener('touchstart', (e) => {
          isDragging = true;
          digTile(tile);
          e.preventDefault();
        });
        tile.addEventListener('touchmove', (e) => {
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (isDragging && target && target.classList.contains('tile')) {
            digTile(target);
          }
        });
        gridEl.appendChild(tile);
      }
      document.addEventListener('mouseup', () => { isDragging = false; });
      document.addEventListener('touchend', () => { isDragging = false; });
    }

    function digTile(tile) {
      if (tile.classList.contains('dirt')) {
        tile.style.background = '#b3e5fc';
        tile.classList.remove('dirt');
        tile.textContent = '';
      } else if (tile.classList.contains('bonus')) {
        tile.style.background = '#b3e5fc';
        tile.classList.remove('bonus');
        tile.textContent = '';
        bonus++;
        bonusEl.textContent = bonus;
      } else if (tile.classList.contains('rock') || tile.classList.contains('dirty')) {
        points = Math.max(0, points - 2);
        pointsEl.textContent = points;
        showMinusTwoOverlay();
        resetGridToCurrentLayout();
      }
    }

    function showMinusTwoOverlay() {
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '50%';
      overlay.style.left = '50%';
      overlay.style.transform = 'translate(-50%, -50%)';
      overlay.style.fontSize = '3rem';
      overlay.style.fontWeight = 'bold';
      overlay.style.color = 'red';
      overlay.style.background = 'rgba(255,255,255,0.8)';
      overlay.style.padding = '20px 40px';
      overlay.style.borderRadius = '12px';
      overlay.style.zIndex = '9999';
      overlay.innerText = '-2';
      document.body.appendChild(overlay);
      setTimeout(() => {
        document.body.removeChild(overlay);
      }, 1000);
    }

    function resetGridToCurrentLayout() {
      const tiles = gridEl.children;
      for (let i = 0; i < tiles.length; i++) {
        const tile = tiles[i];
        if (!tile.classList.contains('rock') &&
            !tile.classList.contains('dirty') &&
            !tile.classList.contains('bonus') &&
            !tile.classList.contains('dirt')) {
          tile.className = 'tile dirt';
          tile.style.background = '';
          tile.textContent = '';
          currentGridTypes[i] = 'dirt';
        }
      }
      document.getElementById('success').style.display = 'none';
    }

    function startFlow() {
      let reachedBucket = false;
      const gridTiles = gridEl.children;
      for (let i = 90; i < 100; i++) {
        const tile = gridTiles[i];
        if (!tile.classList.contains('dirt') && !tile.classList.contains('rock') &&
            !tile.classList.contains('dirty') && !tile.classList.contains('bonus')) {
          reachedBucket = true;
        }
      }
      if (reachedBucket) {
        points += 10 + bonus;
        pointsEl.textContent = points;
        document.getElementById('successPoints').textContent = 10 + bonus;
        document.getElementById('success').style.display = 'flex';
        showConfetti(); // Show confetti effect when player wins
      }
    }

    // Simple confetti effect for beginners
    function showConfetti() {
      // Create 30 confetti pieces
      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        // Random color for each piece
        const colors = ['#FFC907', '#2E9DF7', '#8d6e63', '#00b0ff', '#ffd700', '#c97272'];
        confetti.style.position = 'fixed';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = '-30px';
        confetti.style.width = '12px';
        confetti.style.height = '12px';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = '4px';
        confetti.style.opacity = '0.8';
        confetti.style.zIndex = '9999';
        confetti.style.transition = 'top 1.2s linear, left 1.2s linear, opacity 1.2s linear';
        document.body.appendChild(confetti);
        // Animate falling
        setTimeout(() => {
          confetti.style.top = `${60 + Math.random() * 30}vh`;
          confetti.style.left = `${Math.random() * 100}%`;
          confetti.style.opacity = '0';
        }, 10);
        // Remove after animation
        setTimeout(() => {
          document.body.removeChild(confetti);
        }, 1300);
      }
    }

    function resetGame() {
      bonus = 0;
      bonusEl.textContent = bonus;
      buildGrid(true);
      document.getElementById('success').style.display = 'none';
    }

    function hideInstruction() {
      document.getElementById('instruction').style.display = 'none';
    }

    document.getElementById('instruction').style.display = 'flex';
    buildGrid();
    document.getElementById('hideInstructionBtn').onclick = hideInstruction;
    document.getElementById('resetBtn').onclick = resetGame;
    document.getElementById('startFlowBtn').onclick = startFlow;
    document.getElementById('nextLevelBtn').onclick = function() {
      // When Next Level is pressed, go to the next round if not at max
      if (currentRound < maxRounds) {
        currentRound++;
        bonus = 0;
        bonusEl.textContent = bonus;
        buildGrid(false); // false means new grid
        document.getElementById('success').style.display = 'none';
      } else {
        // If finished all rounds, show overlay message
        document.getElementById('success').style.display = 'none';
        document.getElementById('finished').style.display = 'flex';
      }
    };

    document.getElementById('playAgainAllBtn').onclick = function() {
      // Restart from round 1
      currentRound = 1;
      bonus = 0;
      bonusEl.textContent = bonus;
      buildGrid(false);
      document.getElementById('finished').style.display = 'none';
    };
    document.getElementById('stopBtn').onclick = function() {
      // Hide the overlay and optionally do something else
      document.getElementById('finished').style.display = 'none';
    };
    document.getElementById('playAgainBtn').onclick = resetGame;
  </script>
</body>
</html>
